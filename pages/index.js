import { useEffect, useState, useRef, useCallback } from 'react';
import Head from 'next/head';
import Group from '../components/Group';
import styles from '../styles/Home.module.css';
import * as htmlToImage from 'html-to-image';
import { toPng } from 'html-to-image';

export default function Home() {
	const [matches, setMatches] = useState([]);
	const [flags, setFlags] = useState([]);

	useEffect(() => {
		window
			.fetch('/api/')
			.then((res) => res.json())
			.then(({ data }) => {
				setMatches(data);
			});
	}, []);

	useEffect(() => {
		window
			.fetch('/api/flags')
			.then((res) => res.json())
			.then(({ data }) => {
				setFlags(data);
			});
	}, []);

	const allGroups = [];
	matches.map(({ Group }) => {
		if (typeof Group == 'string') {
			allGroups.push(Group);
		}
	});
	const groupList = [...new Set(allGroups)];

	//Download Image 1
	// const domEl = useRef(null);

	// const downloadImage = async () => {
	// 	const dataUrl = await htmlToImage.toJpeg(domEl.current);

	// 	const link = document.createElement('a');
	// 	link.download = 'fixture.jpeg';
	// 	link.href = dataUrl;
	// 	link.click();
	// };
	//Download Image 2
	const ref = useRef(null);

	const onButtonClick = useCallback(() => {
		if (ref.current === null) {
			return;
		}

		toPng(ref.current, { cacheBust: true })
			.then((dataUrl) => {
				const link = document.createElement('a');
				link.download = 'fixture.png';
				link.href = dataUrl;
				link.click();
			})
			.catch((err) => {
				console.log(err);
			});
	}, [ref]);

	return (
		<div>
			<Head>
				<title>Fixture Mundial Qatar 2022</title>
				<meta name='description' content='Generated by create next app' />
				<link rel='icon' href='/favicon.ico' />
				<meta
					name='viewport'
					content='width=device-width, initial-scale=1, maximum-scale=1'
				></meta>
			</Head>
			<main ref={ref}>
				<header>
					<h1 className={styles.title}>
						<a>Fixture Mundial Qatar 2022</a>
					</h1>
				</header>
				<div className={styles.container}>
					{groupList.map((groups) => (
						<section key={groups} className={styles.groups}>
							<Group matches={matches} group={groups} flags={flags} />
						</section>
					))}
				</div>
				<button className={styles.button} onClick={onButtonClick}>
					Descargar Fixture
				</button>
			</main>
		</div>
	);
}
